<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        /* --- 1. General & Theming --- */
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #00ffcc;
            --secondary-color: #2e2e4d;
            --text-color: #e0e0e0;
            --text-muted-color: #a0a0c0;
            --font-family: 'Poppins', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; /* Hide scrollbars */
        }

        .hidden {
            display: none !important;
        }

        /* --- 2. Landing Page & Login --- */
        #three-js-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        #landing-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .hero span {
            color: var(--primary-color);
        }

        .hero p {
            font-size: 1.2rem;
            color: var(--text-muted-color);
            max-width: 500px;
            margin-bottom: 2rem;
        }

        .auth-container {
            background: rgba(46, 46, 77, 0.7);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--secondary-color);
            width: 100%;
            max-width: 400px;
        }

        .auth-container h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .auth-form input {
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .auth-form button {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: var(--bg-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .auth-form button:hover {
            background-color: #00e6b8;
            transform: translateY(-2px);
        }
        
        .auth-toggle {
            margin-top: 1rem;
            color: var(--text-muted-color);
        }

        .auth-toggle a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        #auth-error {
            color: #ff6b6b;
            margin-top: 1rem;
            min-height: 1.2em;
        }


        /* --- 3. Chat Application UI --- */
        #chat-app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar */
        #sidebar {
            width: 300px;
            background-color: var(--secondary-color);
            border-right: 1px solid #3a3a5a;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #3a3a5a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: var(--primary-color);
        }
        
        #sign-out-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        #sign-out-btn:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
        }

        #user-list {
            list-style-type: none;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .user-list-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #3a3a5a;
        }

        .user-list-item:hover {
            background-color: #3a3a5a;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin-right: 1rem;
            position: relative;
        }

        .online-indicator {
            width: 12px;
            height: 12px;
            background-color: #4caf50;
            border-radius: 50%;
            border: 2px solid var(--secondary-color);
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .user-info .username {
            font-weight: 600;
        }
        .user-info .last-active {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            display: block;
        }

        /* Main Chat Window */
        #main-chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
        }

        .chat-header {
            padding: 1rem;
            background-color: var(--secondary-color);
            border-bottom: 1px solid #3a3a5a;
            font-weight: 600;
        }

        #messages-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.8rem 1.2rem;
            border-radius: 18px;
            position: relative;
        }

        .message-bubble.sent {
            background-color: var(--primary-color);
            color: var(--bg-color);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .message-bubble.received {
            background-color: var(--secondary-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .message-meta {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            text-align: right;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .message-status-ticks {
            font-weight: bold;
        }
        .message-status-ticks.seen {
            color: #4caf50; /* Green for seen */
        }
        .message-status-ticks.delivered {
            color: inherit; /* White/default color */
        }

        .delete-icon {
            cursor: pointer;
            display: none; /* Hidden by default */
            font-size: 1rem;
        }
        .message-bubble:hover .delete-icon {
            display: inline; /* Show on hover for desktop */
        }

        #message-form-container {
            padding: 1rem;
            background-color: var(--secondary-color);
        }

        #typing-indicator {
            height: 20px;
            padding: 0 0.5rem;
            color: var(--text-muted-color);
            font-style: italic;
        }

        #message-form {
            display: flex;
            gap: 1rem;
        }

        #message-input {
            flex-grow: 1;
            padding: 0.8rem 1rem;
            border-radius: 20px;
            border: 1px solid #3a3a5a;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
        }
        #message-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        #message-form button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 20px;
            background: var(--primary-color);
            color: var(--bg-color);
            font-weight: 600;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <!-- =================================== -->
    <!--          LANDING/LOGIN PAGE         -->
    <!-- =================================== -->
    <div id="landing-page">
        <div id="three-js-canvas"></div>

        <div class="hero" data-aos="fade-in" data-aos-delay="200">
            <h1>Welcome to <span id="typed-element"></span></h1>
            <p>Real-time, secure, and beautifully designed communication for the modern web.</p>
        </div>

        <div class="auth-container" data-aos="fade-up" data-aos-delay="400">
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <h2>Sign In</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div id="auth-error"></div>
                <p class="auth-toggle">Don't have an account? <a id="show-signup">Sign Up</a></p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden">
                <h2>Create Account</h2>
                <input type="text" id="signup-name" placeholder="Display Name" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p class="auth-toggle">Already have an account? <a id="show-login">Sign In</a></p>
            </form>
        </div>
    </div>


    <!-- =================================== -->
    <!--          MAIN CHAT APP              -->
    <!-- =================================== -->
    <div id="chat-app" class="hidden">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>Users</h2>
                <button id="sign-out-btn">Sign Out</button>
            </div>
            <ul id="user-list">
                <!-- User list items will be generated by JS -->
            </ul>
        </aside>
        <main id="main-chat-window">
            <div class="chat-header">
                <h3>Global Chat</h3>
            </div>
            <div id="messages-container">
                <!-- Messages will be injected here -->
            </div>
            <div id="message-form-container">
                <div id="typing-indicator"></div>
                <form id="message-form">
                    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </main>
    </div>


    <!-- =================================== -->
    <!--          SCRIPTS SECTION            -->
    <!-- =================================== -->
    
    <!-- Third-party Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>


    <!-- Firebase SDK - using ES Modules -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, onDisconnect, serverTimestamp, remove, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // ----- 1. CONFIG & INITIALIZATION -----
        // IMPORTANT: Replace with your project's Firebase configuration
        const firebaseConfig = {
            const firebaseConfig = {
            apiKey: "AIzaSyCPTlKkV5PK1XjwMtxuNrowmP4Qt3py0sE",
            authDomain: "login-8f29c.firebaseapp.com",
            databaseURL: "https://login-8f29c-default-rtdb.firebaseio.com",
            projectId: "login-8f29c",
            storageBucket: "login-8f29c.firebasestorage.app",
            messagingSenderId: "935493666066",
            appId: "1:935493666066:web:baeeebb56ead2604241fcb",
            measurementId: "G-R53KQHSL99"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        const CHAT_ID = "global_chat"; // Using one global chat room for simplicity

        
        // ----- 2. DOM ELEMENT REFERENCES -----
        const landingPage = document.getElementById('landing-page');
        const chatApp = document.getElementById('chat-app');
        
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');

        const signOutBtn = document.getElementById('sign-out-btn');
        const userList = document.getElementById('user-list');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator');

        // ----- 3. LANDING PAGE ANIMATIONS -----
        function initLandingPageAnimations() {
            AOS.init();

            new Typed('#typed-element', {
                strings: ['Sintha Chat.', 'Real-time.', 'Secure.', 'Beautiful.'],
                typeSpeed: 60,
                backSpeed: 40,
                loop: true,
            });

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('three-js-canvas').appendChild(renderer.domElement);

            const particlesGeometry = new THREE.BufferGeometry;
            const particlesCount = 8000;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i = 0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 10;
            }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.008, color: 0x00ffcc });
            const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particlesMesh);
            camera.position.z = 5;

            const animate = () => {
                requestAnimationFrame(animate);
                particlesMesh.rotation.x += 0.0002;
                particlesMesh.rotation.y += 0.0003;
                renderer.render(scene, camera);
            };
            animate();
            
            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });
        }
        
        // ----- 4. UI MANIPULATION & HELPERS -----
        function toggleAuthForms() {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            authError.textContent = '';
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatLastActive(timestamp) {
            if (!timestamp) return '...';
            const now = new Date();
            const lastActive = new Date(timestamp);
            const diffMs = now - lastActive;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return lastActive.toLocaleDateString();
        }

        function renderUserList(users) {
            userList.innerHTML = '';
            const sortedUsers = Object.entries(users).sort((a,b) => b[1].isOnline - a[1].isOnline);
            
            for (const [uid, user] of sortedUsers) {
                const li = document.createElement('li');
                li.className = 'user-list-item';
                li.innerHTML = `
                    <div class="user-avatar">
                        ${user.isOnline ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="user-info">
                        <span class="username">${user.displayName || 'Anonymous'}</span>
                        <span class="last-active">${user.isOnline ? 'Online' : 'Active ' + formatLastActive(user.last_active)}</span>
                    </div>
                `;
                userList.appendChild(li);
            }
        }
        
        function renderMessage(messageId, message) {
            const isSent = message.senderId === currentUser.uid;
            const bubble = document.createElement('div');
            bubble.id = messageId;
            bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;

            const ticksId = `ticks-${messageId}`;
            bubble.innerHTML = `
                <p class="message-text">${message.text}</p>
                <span class="message-meta">
                    <span class="message-time">${formatTimestamp(message.timestamp)}</span>
                    ${isSent ? `<span id="${ticksId}" class="message-status-ticks"></span>` : ''}
                    <span class="delete-icon" title="Delete Message">🗑️</span>
                </span>
            `;

            messagesContainer.appendChild(bubble);

            // Add delete functionality
            const deleteIcon = bubble.querySelector('.delete-icon');
            let pressTimer;
            const startPress = () => {
                pressTimer = setTimeout(() => {
                   if (isSent && confirm('Are you sure you want to delete this message?')) {
                        const messageRef = ref(db, `messages/${CHAT_ID}/${messageId}`);
                        remove(messageRef);
                   }
                }, 800); // 800ms hold
            };
            const cancelPress = () => clearTimeout(pressTimer);
            
            // For both mouse and touch
            bubble.addEventListener('mousedown', startPress);
            bubble.addEventListener('mouseup', cancelPress);
            bubble.addEventListener('mouseleave', cancelPress);
            bubble.addEventListener('touchstart', startPress);
            bubble.addEventListener('touchend', cancelPress);
            
            // Non-hold click for desktop
            deleteIcon.addEventListener('click', (e) => {
                e.stopPropagation(); // prevent triggering the hold listener
                if (isSent && confirm('Are you sure you want to delete this message?')) {
                    const messageRef = ref(db, `messages/${CHAT_ID}/${messageId}`);
                    remove(messageRef);
                }
            });

            updateMessageStatusUI(messageId, message.status);
            gsap.from(bubble, { opacity: 0, y: 20, duration: 0.5 });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function updateMessageStatusUI(messageId, status) {
            const ticksElement = document.getElementById(`ticks-${messageId}`);
            if (!ticksElement) return;

            ticksElement.classList.remove('seen', 'delivered');
            switch (status) {
                case 'sent':
                    ticksElement.innerHTML = '✓';
                    break;
                case 'delivered':
                    ticksElement.innerHTML = '✓✓';
                    ticksElement.classList.add('delivered');
                    break;
                case 'seen':
                    ticksElement.innerHTML = '✓✓';
                    ticksElement.classList.add('seen');
                    break;
            }
        }
        
        function removeMessageFromUI(messageId) {
            const messageEl = document.getElementById(messageId);
            if(messageEl) {
                gsap.to(messageEl, { opacity: 0, x: 50, duration: 0.5, onComplete: () => messageEl.remove() });
            }
        }

        // ----- 5. FIREBASE LOGIC -----
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                landingPage.classList.add('hidden');
                chatApp.classList.remove('hidden');
                initChat();
            } else {
                currentUser = null;
                landingPage.classList.remove('hidden');
                chatApp.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => { authError.textContent = err.message; });
        });

        signupForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = signupForm['signup-name'].value;
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;

            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    // Update profile and create user entry in DB
                    return updateProfile(user, { displayName: name })
                        .then(() => {
                            const userRef = ref(db, 'users/' + user.uid);
                            set(userRef, {
                                displayName: name,
                                email: user.email,
                            });
                        });
                })
                .catch(err => { authError.textContent = err.message; });
        });

        signOutBtn.addEventListener('click', () => signOut(auth));


        // --- Chat Initialization & Core Logic ---
        function initChat() {
            messagesContainer.innerHTML = '';
            setupPresence();
            listenForUsers();
            listenForMessages();
            listenForTyping();
            
            // Auto-mark messages as 'seen'
            const messagesRef = ref(db, `messages/${CHAT_ID}`);
            onValue(messagesRef, (snapshot) => {
                snapshot.forEach(childSnapshot => {
                    const msg = childSnapshot.val();
                    if(msg.senderId !== currentUser.uid && msg.status !== 'seen') {
                        const msgRef = ref(db, `messages/${CHAT_ID}/${childSnapshot.key}`);
                        set({ ...msg, status: 'seen' });
                    }
                });
            }, { onlyOnce: false });
        }

        function setupPresence() {
            const userStatusRef = ref(db, `users/${currentUser.uid}`);
            const presenceRef = ref(db, '.info/connected');

            onValue(presenceRef, (snap) => {
                if (snap.val() === true) {
                    const con = onDisconnect(userStatusRef);
                    con.update({
                        isOnline: false,
                        last_active: serverTimestamp()
                    });
                    
                    set(userStatusRef, {
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        isOnline: true,
                        last_active: serverTimestamp()
                    });
                }
            });
        }

        function listenForUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val() || {};
                renderUserList(users);
            });
        }

        function listenForMessages() {
            const messagesRef = ref(db, `messages/${CHAT_ID}`);
            
            onValue(messagesRef, (snapshot) => {
                messagesContainer.innerHTML = ''; // Full re-render on any change
                if(snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        renderMessage(childSnapshot.key, childSnapshot.val());
                    });
                }
            });
        }
        
        function listenForTyping() {
            const typingRef = ref(db, `typing/${CHAT_ID}`);
            
            // Listen for others typing
            onValue(typingRef, (snapshot) => {
                const typingUsers = snapshot.val() || {};
                delete typingUsers[currentUser.uid]; // Don't show myself
                
                const names = Object.values(typingUsers);
                if(names.length === 0) {
                    typingIndicator.textContent = '';
                } else if (names.length === 1) {
                    typingIndicator.textContent = `${names[0]} is typing...`;
                } else {
                    typingIndicator.textContent = `${names.join(', ')} are typing...`;
                }
            });

            // Set my typing status
            let typingTimeout;
            messageInput.addEventListener('input', () => {
                const myTypingRef = ref(db, `typing/${CHAT_ID}/${currentUser.uid}`);
                set(myTypingRef, currentUser.displayName);

                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    remove(myTypingRef);
                }, 3000); // Remove after 3s of inactivity
            });
        }

        messageForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            
            const messagesRef = ref(db, `messages/${CHAT_ID}`);
            const newMessageRef = push(messagesRef);

            set(newMessageRef, {
                senderId: currentUser.uid,
                senderName: currentUser.displayName,
                text: text,
                timestamp: serverTimestamp(),
                status: 'sent' // Sent -> Delivered -> Seen
            });

            messageInput.value = '';
            
            // Clear my typing indicator immediately after sending
            const myTypingRef = ref(db, `typing/${CHAT_ID}/${currentUser.uid}`);
            remove(myTypingRef);
        });

        
        // ----- 6. APP START & EVENT LISTENERS -----
        document.addEventListener('DOMContentLoaded', () => {
            initLandingPageAnimations();
            
            showSignupBtn.addEventListener('click', toggleAuthForms);
            showLoginBtn.addEventListener('click', toggleAuthForms);
        });

    </script>
</body>
</html>
