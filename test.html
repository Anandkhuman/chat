<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-family-sans: 'Inter', system-ui, -apple-system, sans-serif;
            --bg-dark: #0D1117;
            --bg-medium: #161B22;
            --bg-light: #21262D;
            --border-color: #30363D;
            --primary: #58A6FF;
            --primary-hover: #79c0ff;
            --text-light: #E6EDF3;
            --text-medium: #C9D1D9;
            --text-dark: #8B949E;
            --seen-color: #3FB950;
            --error-color: #F87171;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-family-sans);
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }

        /* --- Landing Page & Auth --- */
        #landing-page {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; text-align: center; padding: 2rem;
        }
        #three-js-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .hero h1 { font-size: clamp(2.8rem, 8vw, 4rem); font-weight: 700; }
        .hero span { color: var(--primary); }
        .hero p { font-size: clamp(1rem, 4vw, 1.25rem); color: var(--text-medium); max-width: 550px; margin: 1.5rem 0 3rem; }
        .auth-container {
            background: rgba(22, 27, 34, 0.7); backdrop-filter: blur(12px);
            padding: 2.5rem; border-radius: 1rem; border: 1px solid var(--border-color);
            width: 100%; max-width: 420px; text-align: left;
        }
        .auth-form input {
            width: 100%; padding: 0.8rem 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;
            border: 1px solid var(--border-color); background: var(--bg-dark);
            color: var(--text-light); font-size: 1rem; transition: all 0.2s;
        }
        .auth-form input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        .auth-form button {
            width: 100%; padding: 0.8rem; border: none; border-radius: 0.5rem;
            background: var(--primary); color: var(--bg-dark); font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .auth-form button:hover { background-color: var(--primary-hover); }
        #auth-error { margin-top: 1rem; text-align: center; min-height: 1.2em; font-weight: 500; }
        .auth-links { display: flex; justify-content: space-between; margin-top: 1.5rem; font-size: 0.9rem; }
        .auth-links a { color: var(--primary); text-decoration: none; font-weight: 500; }

        /* --- Chat App Layout --- */
        #chat-app { display: flex; height: 100vh; width: 100vw; }
        .icon { width: 1.25rem; height: 1.25rem; }
        
        #sidebar {
            width: 320px; background: var(--bg-medium);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header {
            padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        #sidebar-title { font-size: 1.5rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #sidebar-title span { color: var(--primary); }
        .new-chat-btn {
             background: transparent; border: 1px solid var(--border-color); padding: 0.5rem;
             border-radius: 0.5rem; cursor: pointer; color: var(--text-dark);
             transition: all 0.2s;
        }
        .new-chat-btn:hover { color: var(--text-light); border-color: var(--primary); background: var(--bg-light); }
        
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
        .conversation-item {
            display: flex; align-items: center; padding: 0.75rem;
            cursor: pointer; transition: background-color 0.2s;
            border-radius: 0.5rem;
        }
        .conversation-item:hover { background-color: var(--bg-light); }
        .conversation-item.active { background-color: var(--primary); }
        .conversation-item.active .name, .conversation-item.active .last-message { color: var(--bg-dark); }
        .conversation-item.active .avatar { background-color: var(--bg-dark); color: var(--primary); }
        
        .avatar {
            width: 44px; height: 44px; border-radius: 50%;
            background-color: var(--primary); margin-right: 1rem;
            position: relative; flex-shrink: 0;
            display: grid; place-items: center; font-weight: 600;
            color: var(--bg-dark);
        }
        .online-indicator {
            width: 12px; height: 12px; background-color: var(--seen-color);
            border-radius: 50%; border: 2px solid var(--bg-medium);
            position: absolute; bottom: 0; right: 0;
        }
        .item-details { overflow: hidden; }
        .item-details .name { font-weight: 500; color: var(--text-light); white-space: nowrap; text-overflow: ellipsis; }
        .item-details .last-message { font-size: 0.875rem; color: var(--text-dark); white-space: nowrap; text-overflow: ellipsis; }
        
        .profile-section {
            padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);
            display: flex; align-items: center;
        }
        #profile-avatar { width: 40px; height: 40px; }
        #current-user-name { flex-grow: 1; font-weight: 500; }
        .profile-actions { display: flex; gap: 0.25rem; }
        .profile-actions button {
            background: none; border: none; color: var(--text-dark); cursor: pointer;
            padding: 0.5rem; border-radius: 0.375rem; transition: all 0.2s;
        }
        .profile-actions button:hover { color: var(--text-light); background-color: var(--bg-light); }
        
        /* Main Chat Window */
        #main-chat-window { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-dark); }
        .chat-header {
            padding: 1.25rem 1.75rem; background-color: var(--bg-medium);
            border-bottom: 1px solid var(--border-color); font-weight: 600;
        }
        #welcome-screen {
            flex-grow: 1; display: grid; place-items: center; text-align: center;
            color: var(--text-dark);
        }
        #messages-container {
            flex-grow: 1; padding: 1.5rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 0.25rem;
        }
        .message-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .message-group.sent { align-items: flex-end; }
        .message-group.received { align-items: flex-start; }
        .message-bubble {
            max-width: 75%; padding: 0.75rem 1.25rem;
            position: relative; word-wrap: break-word; font-size: 0.95rem;
            border-radius: 1.25rem;
        }
        .message-group.sent .message-bubble { background-color: var(--primary); color: var(--bg-dark); border-bottom-right-radius: 0.375rem; }
        .message-group.received .message-bubble { background-color: var(--bg-light); color: var(--text-light); border-bottom-left-radius: 0.375rem; }
        .sender-name { font-size: 0.8rem; font-weight: 500; color: var(--text-dark); margin: 0 0 0.5rem 0.5rem; }
        .message-meta { font-size: 0.75rem; text-align: right; opacity: 0.7; margin-top: 0.375rem; display: flex; align-items: center; gap: 0.375rem; }
        .message-status-ticks { font-weight: bold; color: var(--bg-dark); }
        .message-status-ticks.seen { color: var(--seen-color); }
        
        #message-form-container { padding: 1rem 1.75rem; border-top: 1px solid var(--border-color); }
        #typing-indicator { height: 20px; font-size: 0.85rem; padding-bottom: 0.5rem; color: var(--text-dark); }
        #message-form { display: flex; align-items: center; gap: 1rem; }
        #message-input {
            flex-grow: 1; padding: 0.8rem 1.25rem; border-radius: 0.5rem;
            border: 1px solid var(--border-color); background: var(--bg-medium);
            color: var(--text-light); font-size: 1rem;
        }
        #message-input:focus { outline: none; border-color: var(--primary); }
        #message-form button {
            background-color: var(--primary); border: none; border-radius: 0.5rem;
            width: 48px; height: 48px; flex-shrink: 0;
            display: grid; place-items: center; cursor: pointer; transition: all 0.2s;
        }
        #message-form button:hover { background-color: var(--primary-hover); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 17, 23, 0.6); backdrop-filter: blur(8px);
            display: grid; place-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--bg-medium); padding: 2rem; border-radius: 1rem;
            width: 90%; max-width: 450px; border: 1px solid var(--border-color);
        }
        #modal-user-search { width:100%; margin-bottom: 1rem; }
        .modal-user-list { max-height: 300px; overflow-y: auto; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        
        @media (max-width: 768px) { html { font-size: 14px; } #sidebar{ width: 0; padding: 0; border: none; } }
    </style>
</head>
<body>

    <svg width="0" height="0" style="display: none;">
      <symbol id="icon-plus" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></symbol>
      <symbol id="icon-edit" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></symbol>
      <symbol id="icon-logout" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></symbol>
      <symbol id="icon-send" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></symbol>
    </svg>

    <div id="landing-page">
        <div id="three-js-canvas"></div>
        <div class="hero">
            <h1>Sintha Chat<span>.</span></h1>
            <p>Modern real-time communication, redesigned for clarity and focus.</p>
        </div>
        <div class="auth-container">
            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" placeholder="Email Address" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Sign In</button>
            </form>
            <form id="signup-form" class="auth-form hidden">
                <input type="text" id="signup-name" placeholder="Display Name" required>
                <input type="email" id="signup-email" placeholder="Email Address" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6)" required>
                <button type="submit">Create Account</button>
            </form>
            <div id="auth-error"></div>
            <div class="auth-links">
                <a href="#" id="forgot-password-link">Forgot Password?</a>
                <a href="#" id="auth-toggle-link">Sign Up</a>
            </div>
        </div>
    </div>

    <div id="chat-app" class="hidden">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h1 id="sidebar-title">Sintha<span>.</span></h1>
                <button id="new-chat-btn" class="new-chat-btn" title="New Chat"><svg class="icon"><use href="#icon-plus"></use></svg></button>
            </div>
            <div class="sidebar-content">
                <ul id="my-chats-list"></ul>
            </div>
            <div class="profile-section">
                <div id="profile-avatar" class="avatar"></div>
                <div id="current-user-name"></div>
                <div class="profile-actions">
                    <button id="edit-name-btn" title="Edit name"><svg class="icon"><use href="#icon-edit"></use></svg></button>
                    <button id="sign-out-btn" title="Sign Out"><svg class="icon"><use href="#icon-logout"></use></svg></button>
                </div>
            </div>
        </aside>
        
        <main id="main-chat-window">
             <div id="welcome-screen"><h2>Select a conversation to begin.</h2></div>
            <div id="chat-view" class="hidden">
                <div class="chat-header"><span id="chat-header-title"></span></div>
                <div id="messages-container"></div>
                <div id="message-form-container">
                    <div id="typing-indicator"></div>
                    <form id="message-form">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required>
                        <button type="submit" title="Send"><svg class="icon" style="color: var(--bg-dark);"><use href="#icon-send"></use></svg></button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <div id="new-group-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Start a new conversation</h3>
            <p>Select users to begin a 1-on-1 or group chat.</p>
            <form id="new-group-form">
                <input type="text" id="modal-user-search" class="auth-form" placeholder="Search for users...">
                <div id="group-name-container" class="hidden">
                    <input type="text" id="group-name-input" class="auth-form" placeholder="Group Name (required)">
                </div>
                <div class="modal-user-list"></div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" id="create-group-cancel" class="auth-form" style="background: var(--bg-light);">Cancel</button>
                    <button type="submit" id="create-group-submit" class="auth-form">Start Chat</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, onDisconnect, serverTimestamp, update, off, get, child, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // ----- 1. CONFIG & INITIALIZATION -----
        const firebaseConfig = {
            apiKey: "AIzaSyCPTlKkV5PK1XjwMtxuNrowmP4Qt3py0sE",
            authDomain: "login-8f29c.firebaseapp.com",
            databaseURL: "https://login-8f29c-default-rtdb.firebaseio.com",
            projectId: "login-8f29c",
            storageBucket: "login-8f29c.firebasestorage.app",
            messagingSenderId: "935493666066",
            appId: "1:935493666066:web:baeeebb56ead2604241fcb",
            measurementId: "G-R53KQHSL99"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global State & DOM Refs
        let currentUser, currentChatId;
        let conversationsListener, messageListener, typingListener, usersListener;
        let allUsersCache = {};
        const D = id => document.getElementById(id); // Helper
        const [landingPage, chatApp, loginForm, signupForm, authError, myChatsList, currentUserNameEl, editNameBtn, signOutBtn, welcomeScreen, chatView, chatHeaderTitle, messagesContainer, messageForm, messageInput, typingIndicator, newChatBtn, newGroupModal, newGroupForm, createGroupCancelBtn, threeJsCanvas, profileAvatar, forgotPasswordLink, authToggleLink, sidebarTitle] = ['landing-page', 'chat-app', 'login-form', 'signup-form', 'auth-error', 'my-chats-list', 'current-user-name', 'edit-name-btn', 'sign-out-btn', 'welcome-screen', 'chat-view', 'chat-header-title', 'messages-container', 'message-form', 'message-input', 'typing-indicator', 'new-chat-btn', 'new-group-modal', 'new-group-form', 'create-group-cancel', 'three-js-canvas', 'profile-avatar', 'forgot-password-link', 'auth-toggle-link', 'sidebar-title'].map(D);

        // ----- 3. UI/HELPER FUNCTIONS -----
        function renderMyChats(chatsData) {
            myChatsList.innerHTML = '';
            if (chatsData.length === 0) {
                myChatsList.innerHTML = '<li style="padding: 0.75rem; color: var(--text-dark); font-size: 0.9rem;">No active chats.</li>';
                return;
            }
            chatsData.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
            chatsData.forEach(chat => {
                const li = document.createElement('li');
                li.className = 'conversation-item';
                li.dataset.chatId = chat.id;
                if (chat.id === currentChatId) li.classList.add('active');
                
                let avatarInitial = '?', chatName = 'Unknown', isOnline = false;
                if (chat.isGroup) {
                    avatarInitial = (chat.groupName || 'G').charAt(0).toUpperCase();
                    chatName = chat.groupName || 'Group Chat';
                } else {
                    const otherUserId = Object.keys(chat.members).find(id => id !== currentUser.uid);
                    const otherUser = allUsersCache[otherUserId];
                    if(otherUser) {
                        chatName = otherUser.displayName;
                        avatarInitial = chatName.charAt(0).toUpperCase();
                        isOnline = otherUser.isOnline;
                    }
                }
                const lastMsg = chat.lastMessage;
                const lastMsgText = lastMsg?.text ? (lastMsg.senderId === currentUser.uid ? "You: " : "") + lastMsg.text : "Chat created.";
                li.innerHTML = `<div class="avatar">${avatarInitial}</div><div class="item-details"><div class="name">${chatName}</div><div class="last-message">${lastMsgText}</div></div>`;
                if(isOnline && !chat.isGroup) li.querySelector('.avatar').insertAdjacentHTML('beforeend', '<div class="online-indicator"></div>');
                li.addEventListener('click', () => selectChat(chat.id));
                myChatsList.appendChild(li);
            });
            gsap.from(myChatsList.children, { opacity: 0, y: 10, stagger: 0.05, duration: 0.3 });
        }
        
        async function selectChat(chatId) {
            if (currentChatId === chatId) return;
            currentChatId = chatId;
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.conversation-item[data-chat-id="${chatId}"]`)?.classList.add('active');
            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            gsap.from(chatView, { opacity: 0, duration: 0.3 });
            const chatSnap = await get(ref(db, `chats/${chatId}`));
            const chatData = chatSnap.val();
            if (!chatData) return;
            chatHeaderTitle.textContent = chatData.isGroup ? chatData.groupName : allUsersCache[Object.keys(chatData.members).find(id => id !== currentUser.uid)]?.displayName || '...';
            listenForMessages(chatId, chatData.isGroup);
            listenForTyping(chatId);
            messageInput.focus();
        }

        // ----- 4. CORE FIREBASE LOGIC -----
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                gsap.to(landingPage, { opacity: 0, duration: 0.5, onComplete: () => landingPage.classList.add('hidden') });
                chatApp.classList.remove('hidden');
                gsap.from(chatApp, { opacity: 0, duration: 0.5, delay: 0.5 });
                initChatApp();
            } else {
                [conversationsListener, messageListener, typingListener, usersListener].forEach(l => l && off(l.ref, l.type));
                currentUser = null;
                landingPage.style.opacity = '1';
                landingPage.classList.remove('hidden');
                chatApp.classList.add('hidden');
                sidebarTitle.innerHTML = 'Sintha<span>.</span>';
            }
        });

        function initChatApp() {
            currentUserNameEl.textContent = currentUser.displayName;
            profileAvatar.textContent = currentUser.displayName.charAt(0).toUpperCase();
            sidebarTitle.textContent = currentUser.displayName;
            setupPresence();
            listenForUsers();
            listenForMyChats();
        }
        
        function setupPresence() {
            const userStatusRef = ref(db, `users/${currentUser.uid}`);
            onDisconnect(userStatusRef).update({ isOnline: false, last_active: serverTimestamp() });
            update(userStatusRef, { displayName: currentUser.displayName, email: currentUser.email, isOnline: true, last_active: serverTimestamp() });
        }
        
        function listenForUsers() {
            if(usersListener) off(usersListener.ref, usersListener.type);
            const usersRef = ref(db, 'users');
            usersListener = { ref: usersRef, type: 'value' };
            onValue(usersRef, (snapshot) => { allUsersCache = snapshot.val() || {}; });
        }

        function listenForMyChats() {
            if(conversationsListener) off(conversationsListener.ref, conversationsListener.type);
            const userChatsRef = ref(db, `userChats/${currentUser.uid}`);
            conversationsListener = { ref: userChatsRef, type: 'value' };
            onValue(userChatsRef, async (snapshot) => {
                if (!snapshot.exists()) { renderMyChats([]); return; }
                const chatPromises = Object.keys(snapshot.val()).map(id => get(child(ref(db), `chats/${id}`)));
                const chatSnapshots = await Promise.all(chatPromises);
                const chatsData = chatSnapshots.filter(s => s.exists()).map(s => ({ id: s.key, ...s.val() }));
                renderMyChats(chatsData);
            });
        }
        
        function listenForMessages(chatId, isGroup) {
            if (messageListener) off(messageListener.ref, messageListener.type);
            messagesContainer.innerHTML = '';
            const messagesRef = ref(db, `messages/${chatId}`);
            messageListener = { ref: messagesRef, type: 'value' };
            onValue(messagesRef, (snapshot) => {
                messagesContainer.innerHTML = '';
                if (!snapshot.exists()) return;
                const updates = {};
                const sortedMessages = Object.entries(snapshot.val()).sort((a,b) => a[1].timestamp - b[1].timestamp);

                sortedMessages.forEach(([msgId, msg], index) => {
                    const isSent = msg.senderId === currentUser.uid;
                    let messageGroup = messagesContainer.lastElementChild;
                    if (!messageGroup || messageGroup.dataset.senderId !== msg.senderId) {
                        messageGroup = document.createElement('div');
                        messageGroup.className = `message-group ${isSent ? 'sent' : 'received'}`;
                        messageGroup.dataset.senderId = msg.senderId;
                        if(!isSent && isGroup) messageGroup.innerHTML = `<div class="sender-name">${allUsersCache[msg.senderId]?.displayName || '...'}</div>`;
                        messagesContainer.appendChild(messageGroup);
                    }
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    const ticksHTML = isSent ? `<span class="message-status-ticks"></span>` : '';
                    bubble.innerHTML = `<p>${msg.text}</p><span class="message-meta"><span>${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>${ticksHTML}</span>`;
                    messageGroup.appendChild(bubble);

                    const ticksElement = bubble.querySelector('.message-status-ticks');
                    if (ticksElement) {
                        ticksElement.classList.remove('seen');
                        if (msg.status === 'seen') { ticksElement.innerHTML = '✓✓'; ticksElement.classList.add('seen'); }
                        else { ticksElement.innerHTML = '✓'; }
                    }
                    if (!isSent && msg.status !== 'seen') updates[`/messages/${chatId}/${msgId}/status`] = 'seen';
                    if (index === sortedMessages.length - 1) gsap.from(bubble, { y: 20, opacity: 0, duration: 0.3, ease: 'power2.out' });
                });
                
                if (Object.keys(updates).length > 0) update(ref(db), updates);
                gsap.to(messagesContainer, { scrollTop: messagesContainer.scrollHeight, duration: 0.5 });
            });
        }
        
        function listenForTyping(chatId) {
            if (typingListener) off(typingListener.ref, typingListener.type);
            const typingRef = ref(db, `typing/${chatId}`);
            typingListener = { ref: typingRef, type: 'value' };
            onValue(typingRef, (snapshot) => {
                const names = Object.values(snapshot.val() || {}).filter(name => name !== currentUser.displayName);
                typingIndicator.textContent = names.length ? `${names.join(', ')} is typing...` : '';
            });
        }

        async function createNewChat(selectedUserIds, groupName = '') {
            const members = [currentUser.uid, ...selectedUserIds];
            const isGroup = members.length > 2;

            let chatId;
            if(isGroup) {
                chatId = push(child(ref(db), 'chats')).key;
            } else {
                chatId = [currentUser.uid, selectedUserIds[0]].sort().join('_');
                if ((await get(ref(db, `chats/${chatId}`))).exists()) { selectChat(chatId); return; }
            }
            
            const chatData = { members: members.reduce((acc, id) => ({...acc, [id]: true }), {}), createdAt: serverTimestamp(), isGroup: isGroup, lastMessage: { text: '', timestamp: serverTimestamp(), senderId: '' } };
            if(isGroup) chatData.groupName = groupName;
            
            const updates = {};
            updates[`/chats/${chatId}`] = chatData;
            members.forEach(id => { updates[`/userChats/${id}/${chatId}`] = true; });
            await update(ref(db), updates);
            selectChat(chatId);
        }

        // ----- 5. EVENT LISTENERS -----
        loginForm.addEventListener('submit', e => { e.preventDefault(); signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['password'].value).catch(err => authError.textContent = "Invalid email or password."); });
        signupForm.addEventListener('submit', e => { e.preventDefault(); const name = signupForm['signup-name'].value; if (name.length < 3) { authError.textContent = 'Display name minimum 3 characters.'; return; } createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['password'].value).then(cred => updateProfile(cred.user, { displayName: name })).catch(err => authError.textContent = err.code.includes('in-use') ? 'Email already in use.' : 'Password minimum 6 characters.'); });
        
        authToggleLink.addEventListener('click', e => {
            e.preventDefault();
            const isLoginVisible = !loginForm.classList.contains('hidden');
            loginForm.classList.toggle('hidden', !isLoginVisible);
            signupForm.classList.toggle('hidden', isLoginVisible);
            authToggleLink.textContent = isLoginVisible ? 'Sign In' : 'Sign Up';
        });

        forgotPasswordLink.addEventListener('click', e => {
            e.preventDefault();
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        authError.textContent = "Password reset email sent! Check your inbox.";
                        authError.style.color = 'var(--seen-color)';
                    })
                    .catch(error => {
                        authError.style.color = 'var(--error-color)';
                        if (error.code === 'auth/user-not-found') {
                            authError.textContent = "No user found with this email address.";
                        } else {
                            authError.textContent = "Error sending reset email. Please try again.";
                        }
                    });
            }
        });

        signOutBtn.addEventListener('click', () => signOut(auth));
        
        editNameBtn.addEventListener('click', () => {
            const newName = prompt("Enter your new display name:", currentUser.displayName);
            if (newName && newName.trim().length >= 3 && newName !== currentUser.displayName) {
                updateProfile(currentUser, { displayName: newName }).then(() => {
                    update(ref(db, `users/${currentUser.uid}`), { displayName: newName });
                    currentUserNameEl.textContent = newName;
                    profileAvatar.textContent = newName.charAt(0).toUpperCase();
                    sidebarTitle.textContent = newName;
                }).catch(err => alert("Error updating name."));
            } else if (newName) {
                alert("Name must be at least 3 characters long.");
            }
        });

        messageForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentChatId) return;
            const messageData = { senderId: currentUser.uid, text, timestamp: serverTimestamp(), status: 'sent' };
            const newMessageKey = push(child(ref(db), 'messages')).key;
            const updates = {};
            updates[`/messages/${currentChatId}/${newMessageKey}`] = messageData;
            updates[`/chats/${currentChatId}/lastMessage`] = messageData;
            update(ref(db), updates);
            messageInput.value = '';
            remove(ref(db, `typing/${currentChatId}/${currentUser.uid}`));
        });
        
        messageInput.addEventListener('input', () => {
            if (!currentChatId) return;
            const myTypingRef = ref(db, `typing/${currentChatId}/${currentUser.uid}`);
            set(myTypingRef, currentUser.displayName);
            setTimeout(() => remove(myTypingRef), 3000);
        });
        
        newChatBtn.addEventListener('click', () => {
            const userListEl = newGroupModal.querySelector('.modal-user-list');
            userListEl.innerHTML = '';
            Object.entries(allUsersCache).filter(([uid]) => uid !== currentUser.uid).forEach(([uid, user]) => {
                userListEl.innerHTML += `<label class="conversation-item"><input type="checkbox" value="${uid}" class="hidden"> <div class="avatar">${user.displayName.charAt(0).toUpperCase()}</div> <div class="item-details"><div class="name">${user.displayName}</div></div> </label>`;
            });
            newGroupModal.classList.remove('hidden');
            gsap.from(newGroupModal.querySelector('.modal-content'), { scale: 0.9, opacity: 0, duration: 0.3, ease: 'power2.out' });
        });
        
        newGroupModal.querySelector('.modal-user-list').addEventListener('change', () => {
            const checkedCount = newGroupForm.querySelectorAll('input:checked').length;
            const container = D('group-name-container');
            if(checkedCount > 1 && container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                gsap.from(container, { height: 0, opacity: 0, duration: 0.3 });
            } else if (checkedCount <= 1 && !container.classList.contains('hidden')) {
                gsap.to(container, { height: 0, opacity: 0, duration: 0.3, onComplete: () => container.classList.add('hidden') });
            }
        });

        D('modal-user-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            newGroupModal.querySelectorAll('.modal-user-list .conversation-item').forEach(item => {
                const name = item.querySelector('.name').textContent.toLowerCase();
                item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        });
        
        createGroupCancelBtn.addEventListener('click', () => newGroupModal.classList.add('hidden'));
        newGroupForm.addEventListener('submit', async e => {
            e.preventDefault();
            const selectedUsers = [...newGroupForm.querySelectorAll('input:checked')].map(el => el.value);
            if (selectedUsers.length === 0) { alert("Please select at least one user."); return; }
            const groupName = D('group-name-input').value.trim();
            if (selectedUsers.length > 1 && !groupName) { alert("Please enter a name for the group."); return; }
            await createNewChat(selectedUsers, groupName);
            newGroupModal.classList.add('hidden');
            newGroupForm.reset();
            D('group-name-container').classList.add('hidden');
        });

        // ----- 6. ANIMATIONS & APP START -----
        function initLandingPageAnimations() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: threeJsCanvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const geometry = new THREE.IcosahedronGeometry(2.5, 1);
            const pointsMaterial = new THREE.PointsMaterial({ color: 0x58A6FF, size: 0.06, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.9 });
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x30363D, transparent: true, opacity: 0.2 });
            
            const points = new THREE.Points(geometry, pointsMaterial);
            const wireframe = new THREE.LineSegments(geometry, lineMaterial);
            scene.add(points);
            scene.add(wireframe);

            camera.position.z = 7;
            const animate = () => {
                requestAnimationFrame(animate);
                points.rotation.x += 0.0005; points.rotation.y += 0.001;
                wireframe.rotation.x -= 0.0003; wireframe.rotation.y -= 0.0005;
                renderer.render(scene, camera);
            };
            animate();
            
            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });
        }
        
        document.addEventListener('DOMContentLoaded', initLandingPageAnimations);
    </script>
</body>
</html>
